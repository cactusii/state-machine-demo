<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" charset="UTF-8">
    <title>statemachine-demo</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <script src="/js/jquery-1.10.2.min.js"></script>
    <script src="/js/echarts.min.js"></script>

</head>

<body style="margin: 20px">
<div class="flexContainer">
    <div style="width: 80%; float:left; height: 1000px; border: 3px solid #1b1e21; border-radius: 10px"
         id="statemachine">
    </div>
    <div style="width: 20%; float:right; height: 1000px; display: flex; align-items: center; padding: 10px">
        <div class="container">
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onclick="doInit()" id="init">init</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(0, 1, 0)" onmouseleave="off(0, 1, 0)" onclick="onClick(0, 1, 0)">创建</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(1, 2, 1)" onmouseleave="off(1, 2, 1)" onclick="onClick(1, 2, 1)">创建完成</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(2, 1, 2)" onmouseleave="off(2, 1, 2)" onclick="onClick(2, 1, 2)">修改配置</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(1, 3, 4)" onmouseleave="off(1, 3, 4)" onclick="onClick(1, 3, 4)">创建异常</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(2, 4, 3)" onmouseleave="off(2, 4, 3)" onclick="onClick(2, 4, 3)">开始演练</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(4, 5, 6)" onmouseleave="off(4, 5, 6)" onclick="onClick(4, 5, 6)">演练完成</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(4, 6, 7)" onmouseleave="off(4, 6, 7)" onclick="onClick(4, 6, 7)">演练异常</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(4, 7, 8)" onmouseleave="off(4, 7, 8)" onclick="onClick(4, 7, 8)">停止</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(2, 8, 5)" onmouseleave="off(2, 8, 5)" onclick="onClick(2, 8, 5)">删除</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(5, 8, 9)" onmouseleave="off(5, 8, 9)" onclick="onClick(5, 8, 9)">删除</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(6, 8, 10)" onmouseleave="off(6, 8, 10)" onclick="onClick(6, 8, 10)">删除</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(7, 8, 11)" onmouseleave="off(7, 8, 11)" onclick="onClick(7, 8, 11)">删除</button>
            </div>
            <div class="row" style="margin: 10px">
                <button type="button" class="btn btn-info" onmouseover="on(3, 8, 12)" onmouseleave="off(3, 8, 12)" onclick="onClick(3, 8, 12)">删除</button>
            </div>

        </div>

    </div>
</div>


<script type="text/javascript">
    var myChart = echarts.init(document.getElementById('statemachine'));
    option = {
        title: {
            text: '故障任务状态转换图',
            left: 'center'
        },
        tooltip: {
            formatter: function (x) {
                return x.data.name;
            }
        },

        series: [
            {
                type: 'graph',
                layout: 'none',
                symbolSize: 80,
                roam: true,
                edgeSymbol: ['circle', 'arrow'],
                edgeSymbolSize: [1, 10],
                draggable: true,
                selectedMode: 'multiple',

                lineStyle: {
                    width: 2,
                    color: '#000',
                },

                label: {
                    show: true,
                    textStyle: {
                        color: '#000',
                        fontSize: '13',
                        fontWeight: 'bold',
                    }
                },

                itemStyle: {
                    color: 'white',
                    borderWidth: 2,
                    borderColor: 'black'
                },

                edgeLabel: {
                    show: true,
                    color: '#000',
                    fontWeight: 'bold',
                    fontSize: '12',
                    formatter: function (x) {
                        return x.data.name;
                    },
                },

                data: [
                    {
                        name: '新建',
                        x: 50,
                        y: 400,
                    },
                    {
                        name: '创建中',
                        x: 200,
                        y: 400,
                    },
                    {
                        name: '创建成功',
                        x: 300,
                        y: 250,
                    },
                    {
                        name: '创建失败',
                        x: 300,
                        y: 550,
                    },
                    {
                        name: '演练中',
                        x: 400,
                        y: 400,
                    },
                    {
                        name: '演练成功',
                        x: 500,
                        y: 300,
                    },
                    {
                        name: '演练失败',
                        x: 550,
                        y: 400,
                    },
                    {
                        name: '演练停止',
                        x: 500,
                        y: 500,
                    },
                    {
                        name: '删除',
                        x: 700,
                        y: 400,
                    }
                ],
                links: [
                    {
                        id: 'l1',
                        source: '新建',
                        target: '创建中',
                        name: '创建',
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l2',
                        source: '创建中',
                        target: '创建成功',
                        name: '创建完成',
                        lineStyle: {
                            width: 2,
                            color: '#000',
                            curveness: 0.3
                        },
                    },
                    {
                        id: 'l3',
                        source: '创建成功',
                        target: '创建中',
                        name: '修改配置',
                        lineStyle: {
                            width: 2,
                            color: '#000',
                            curveness: 0.3
                        },
                    },
                    {
                        id: 'l4',
                        source: '创建成功',
                        target: '演练中',
                        name: '开始演练',
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l5',
                        source: '创建中',
                        target: '创建失败',
                        name: '创建异常',
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l6',
                        source: '创建成功',
                        target: '删除',
                        name: "删除",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                            curveness: 0.5
                        },
                    },
                    {
                        id: 'l7',
                        source: '演练中',
                        target: '演练成功',
                        name: "演练完成",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l8',
                        source: '演练中',
                        target: '演练失败',
                        name: "演练异常",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l9',
                        source: '演练中',
                        target: '演练停止',
                        name: "停止",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l10',
                        source: '演练成功',
                        target: '删除',
                        name: "删除",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l11',
                        source: '演练失败',
                        target: '删除',
                        name: "删除",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l12',
                        source: '演练停止',
                        target: '删除',
                        name: "删除",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                        },
                    },
                    {
                        id: 'l13',
                        source: '创建失败',
                        target: '删除',
                        name: "删除",
                        lineStyle: {
                            width: 2,
                            color: '#000',
                            curveness: -0.5
                        },
                    },
                ]
            }
        ]
    };

    myChart.setOption(option);


    let source = {
        lineStyle: {
            width: 2,
            color: '#000',
        },

        label: {
            show: true,
            textStyle: {
                color: '#000',
                fontSize: '13',
                fontWeight: 'bold',
            }
        },

        itemStyle: {
            color: 'white',
            borderWidth: 2,
            borderColor: 'black'
        },
    };

    let current = {
        itemStyle : {
            color: 'LimeGreen',
            borderWidth: 2,
            borderColor: 'Black',
        },
        label: {
            show: true,
            textStyle: {
                color: '#fff',
                fontSize: '13',
                fontWeight: 'bold',
            }
        },
        lineStyle: {
            width: 2,
            color: '#000',
        },
    };

    let target = {
        itemStyle : {
            color: 'RoyalBlue',
            borderWidth: 2,
            borderColor: 'Black',
        },
        label: {
            show: true,
            textStyle: {
                color: '#fff',
                fontSize: '13',
                fontWeight: 'bold',
            }
        },
        lineStyle: {
            width: 4,
            color: 'red',
        },
    }

    let currentPoint = 0;


    function onClick(p1, p2, l) {
        $.ajax({
            url: "/transform",
            type: "POST",
            data: {
                event: l
            },
            accept: "*/*",
            success: function (data) {
                option.series.at(0).data.at(p1).itemStyle = source.itemStyle;
                option.series.at(0).data.at(p1).label = source.label;
                option.series.at(0).data.at(p2).itemStyle = current.itemStyle;
                option.series.at(0).data.at(p2).label = current.itemStyle;
                option.series.at(0).links.at(l).lineStyle.width = source.lineStyle.width;
                option.series.at(0).links.at(l).lineStyle.color = source.lineStyle.color;
                currentPoint = p2;
                myChart.setOption(option);
                alert(data);
            },
            error: function (data, xhr, errorMeg, e) {
                alert("非法状态转换");
            }
        })
    }

    function on(p1, p2, l) {
        option.series.at(0).data.at(p1).itemStyle = target.itemStyle;
        option.series.at(0).data.at(p1).label = target.label;
        option.series.at(0).data.at(p2).itemStyle = target.itemStyle;
        option.series.at(0).data.at(p2).label = target.label;

        option.series.at(0).links.at(l).lineStyle.width = target.lineStyle.width;
        option.series.at(0).links.at(l).lineStyle.color = target.lineStyle.color;

        myChart.setOption(option);
    }

    function off(p1, p2, l) {
        if (currentPoint === p1) {
            option.series.at(0).data.at(p1).itemStyle = current.itemStyle;
            option.series.at(0).data.at(p1).label = current.label;
        } else {
            option.series.at(0).data.at(p1).itemStyle = source.itemStyle;
            option.series.at(0).data.at(p1).label = source.label;
        }
        if (currentPoint === p2) {
            option.series.at(0).data.at(p2).itemStyle = current.itemStyle;
            option.series.at(0).data.at(p2).label = current.label;
        } else {
            option.series.at(0).data.at(p2).itemStyle = source.itemStyle;
            option.series.at(0).data.at(p2).label = source.label;
        }
        option.series.at(0).links.at(l).lineStyle.width = source.lineStyle.width;
        option.series.at(0).links.at(l).lineStyle.color = source.lineStyle.color;
        myChart.setOption(option);
    }


    function doInit() {
        $.ajax({
            url: "/init",
            type: "POST",
            accept: "*/*",
            success: function (data) {
                option.series.at(0).data.at(0).itemStyle = current.itemStyle;
                option.series.at(0).data.at(0).label = current.label;
                myChart.setOption(option);
                document.getElementById("init").setAttribute("disabled", true);
                alert(data)
            }
        })
    }

</script>

<script src="/js/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="/js/bootstrap.bundle.min.js"
        integrity="sha384-7ymO4nGrkm372HoSbq1OY2DP4pEZnMiA+E0F3zPr+JQQtQ82gQ1HPY3QIVtztVua"
        crossorigin="anonymous"></script>
</body>
</html>